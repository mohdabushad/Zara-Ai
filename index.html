<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zara-Ai</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <link rel="icon" type="image/x-icon" href="/z.png">
    <style>
        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Segoe UI, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #000;

            /* layered ‚Äúmix‚Äù look */
            background:
                radial-gradient(1200px 800px at 80% -10%, rgba(28, 104, 255, 0.55), transparent 60%),
                radial-gradient(900px 700px at 10% 110%, rgba(31, 184, 146, 0.959), transparent 55%),
                radial-gradient(700px 600px at 120% 30%, rgba(218, 141, 147, 0.575), transparent 50%),
                linear-gradient(180deg, #b4d8719a 0%, #e69ad3ab 60%, #a779bd 100%);
        }

        body.active-chat,
        body.active-chat .top,
        body.active-chat .settings-panel,
        body.active-chat .fixed,
        body.active-chat .editable-input {
            background: #ffffff;
            /* ChatGPT style dark bg */

        }

        /* full-screen wave effect */
        /* Typing dots animation */
        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 10px;
            height: 10px;
            background: rgb(0, 0, 0);
            border-radius: 100%;
            display: inline-block;
            animation: blink 1.4s infinite both;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
                transform: scale(0.8);
            }

            20% {
                opacity: 1;
                transform: scale(1.2);
            }

            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
        }

        .body-wave {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            background: radial-gradient(circle, rgb(16, 163, 126) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none;
            z-index: 9999;
            animation: bodyWaveLoop 1.2s ease-out infinite;
        }

        @keyframes bodyWaveLoop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0.8;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        body.dark-theme .body-wave {
            background: radial-gradient(circle, rgb(116, 255, 174) 0%, transparent 70%);
        }


        /* --- Siri-like mic waves --- */
        .siri-wrap {
            position: absolute;
            right: 44px;
            top: 8px;
            /* mic icon ke paas */
            height: 32px;
            width: 120px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-2px) scale(0.98);
            transition: opacity .2s, transform .2s;
        }

        .siri-wrap.active {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .siri-bar {
            width: 4px;
            border-radius: 999px;
            background: currentColor;
            opacity: .85;
            transform-origin: bottom center;
            animation: siriBounce 1.1s ease-in-out infinite;
        }

        body.dark-theme .siri-bar {
            background: #00240f;
            color: #74ffad;
        }

        body.dark-theme .typing-dots span {
            width: 6px;
            height: 10px;
            background: rgb(255, 255, 255);
            border-radius: 50%;
            display: inline-block;
            animation: blink 1.4s infinite both;
        }

        .siri-wrap .siri-bar:nth-child(odd) {
            opacity: .95;
        }

        .siri-wrap .siri-bar:nth-child(3n) {
            opacity: .75;
        }

        @keyframes siriBounce {

            0%,
            100% {
                transform: scaleY(0.3);
            }

            50% {
                transform: scaleY(var(--amp, 1));
            }
        }

        /* mic active state glow */
        .mic-listening {
            box-shadow: 0 0 0 6px rgba(16, 163, 127, .12), 0 0 12px rgba(16, 163, 127, .35);
            border-radius: 50%;
        }


        .fixed {
            border-bottom: 1px solid #eee;
            padding-top: 20px;
            padding-left: 20px;
            width: 257px;
            height: 250px;
            position: fixed;
            background: rgba(218, 141, 199, 0.875);


        }

        .up {
            background-color: #ff7777;
            width: 300px;

        }

        .his {
            margin-top: 250px;
            background:
                radial-gradient(1200px 800px at 80% -10%, rgba(128, 155, 209, 0.55), ),
                radial-gradient(900px 700px at 10% 110%, rgba(171, 192, 209, 0.959), ), turquoise;

        }

        .nav {
            display: flex;
            justify-content: space-between;
        }

        .ai img {
            height: 30px;
            background: transparent;
        }

        .ai i {
            display: flex;
            font-size: 20px;
        }

        .panel-b {
            background-color: transparent;
            display: flex;
            justify-content: center;
            justify-items: end;
            border: none;


        }

        .se {
            width: 80%;
            margin: 10px 0;
            font-size: 15px;
            background-color: #f3f3f3;
            border-radius: 50px;
            border: 2px solid #000000;

        }

        #chat-search {
            width: 70%;
            padding: 10px;
            font-size: 14px;
            background-color: #f3f3f3;
            border: none;
            border-radius: 50px;
        }

        .panel-b i {

            color: #000;
            font-size: 25px;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 260px;
            height: 100%;
            background:
                rgba(218, 141, 199, 0.875);

            transition: left .25s;
            z-index: 1000;
            overflow: auto;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            border-right: 2px solid #eee;

        }

        .settings-panel.open {
            left: 0
        }

        .panel-btn {
            display: flex;
            padding-top: 22px;
            padding-bottom: 22px;
            align-items: center;
            gap: 8px;
            background: transparent;
            color: #000000;
            border: none;
            width: 80%;
            font-size: 15px;
            cursor: pointer;
            border-radius: 6px
        }

        #chat-history {
            list-style: none;
            padding: 0;
            margin: 0
        }

        #chat-history li {
            padding: 8px;

            margin-bottom: 6px;
            border-radius: 6px;
            cursor: pointer
        }

        #chat-history li button {
            font-size: 14px;
            line-height: 1;
            padding: 2px 6px;
            border-radius: 4px;
        }

        #chat-history li button:hover {
            background: rgba(255, 0, 0, 0.1);
        }


        .top {
            /* layered ‚Äúmix‚Äù look */
            background:
                radial-gradient(1200px 800px at 80% -10%, rgba(28, 104, 255, 0.55), transparent 60%),
                radial-gradient(900px 700px at 10% 110%, rgba(31, 184, 146, 0.959), transparent 55%),
                radial-gradient(700px 600px at 120% 30%, rgba(218, 141, 147, 0.575), transparent 50%),
                linear-gradient(180deg, #b4d8719a 0%, #e69ad3ab 60%, #a779bd 100%);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .06);
            position: fixed;
        }

        .ai {
            font-weight: 700
        }

        .top-bar {

            display: flex;
            align-items: center;
            gap: 8px
        }

        #theme {
            color: #000000;
            font-size: 22px;
            border: none;
            background: transparent;
            cursor: pointer;
        }

        .chat-container {
            padding: 20px;
            padding-top: 140px;
            height: calc(100vh - 80px);
            max-width: 800px;
            width: 100%;
            margin: 0 auto;

            display: flex;
            flex-direction: column;
            gap: 0px;
            overflow: auto;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            padding-bottom: 60px;

        }

        .chat-container::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, Edge */
        }

        .center-heading {
            text-align: center;
            color: rgb(26, 1, 1);
            font-size: 40px;
            padding: 10px;
            padding-top: 250px;

        }



        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 14px;
            word-break: break-word
        }

        .message.user {
            max-width: 450px;
            margin-left: auto;
            background: #94ec727c;
            text-align: left;
            margin-bottom: 20px;
        }

        .message.bot {
            max-width: 100%;
            margin-right: auto;
            padding: 0;
            padding-bottom: 40px;

            text-align: left
        }

        form {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px;
            padding: 8px 12px;
            background: transparent;
            z-index: 50;
            box-sizing: border-box
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }


        .editable-input {
            min-height: 126px;
            max-height: 300px;
            padding: 30px 20px 12px 16px;
            border-radius: 28px;
            border: 1px solid #ddd;
            background:
                radial-gradient(1200px 800px at 80% -10%, rgba(28, 104, 255, 0.55), transparent 60%),
                radial-gradient(900px 700px at 10% 110%, rgba(31, 184, 146, 0.959), transparent 55%),
                radial-gradient(700px 600px at 120% 30%, rgba(218, 141, 147, 0.575), transparent 50%),
                linear-gradient(180deg, #b4d8719a 0%, #e69ad3ab 60%, #a779bd 100%);
            outline: none;
            overflow: auto;

        }

        .editable-input:empty:before {
            content: attr(placeholder);
            color: #ffffff
        }

        body.active-chat .editable-input:empty:before {
            color: #8b8b8b;
        }

        .icon-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #000
        }

        .file-icon {
            top: 20px;
            right: 90px;

        }

        .mic-icon {
            top: 20px;
            right: 50px
        }

        .send-btn {
            top: 20px;
            position: absolute;
            right: 12px;
            transform: translateY(-50%);
            background: #10a37f;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        #preview-container {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 6px
        }

        #preview-container img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px
        }

        body.dark-theme .se {

            background-color: #000000;
            border: 2px solid #ffffff;



        }

        body.dark-theme #chat-search {
            border: 2px solid #ffffff;
            color: #c4d6e9;

            background-color: #000000;
            border: none;

        }

        /* dark */
        body.dark-theme {
            background: #0b1220;
            color: #ddd
        }

        body.dark-theme .panel-b i {
            background: #0b1220;
            color: #ff0707;
        }

        body.dark-theme .panel-b {
            background: #0b1220;
        }

        body.dark-theme .fixed {
            background: #0b1220;
        }

        body.dark-theme #chat-search {
            background: #0b1220;

        }

        body.dark-theme .center-heading {
            color: #eeeeee7e;
            background: #0b1220;
        }

        body.dark-theme .settings-panel {
            background: #0b1220;
            color: #ddd;
            border-right: 1px solid #eee;
        }

        body.dark-theme .top {
            background: #0b1220;
            box-shadow: 1px 0px 7px#ffffff;
        }

        body.dark-theme button#theme,
        body.dark-theme button i,
        body.dark-theme label i,
        body.dark-theme .panel-btn {
            color: #ddd;

        }

        body.dark-theme .editable-input,
        body.dark-theme textarea {
            background: #08101a;
            color: #ddd;
            border: 1px solid #c4d6e9
        }

        @media (max-width:754px) {
            .center-heading {
                font-size: 25px;
                top: 35%;
                padding-top: 150px;


            }

            .top {
                height: 50px;

            }


            form {
                position: fixed;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
                max-width: 780px;
                /* ‡§°‡•á‡§∏‡•ç‡§ï‡§ü‡•â‡§™ ‡§ö‡•å‡§°‡§º‡§æ‡§à */
                padding: 8px 12px;
                background: transparent;
            }

            .chat-container {
                padding-bottom: 100px;
                padding-top: 80px;
                margin-left: 0;
                height: calc(100vh - 50px);
                overflow-y: auto;
            }

            .settings-panel {
                width: 220px;
            }

            .fixed {

                border-bottom: 1px solid #eee;

                width: 219px;
                height: 240px;
                position: fixed;


            }

            .editable-input {
                min-height: 80px;
                max-height: 250px;


            }

            hr {
                width: 170px;
                margin: 2px;
            }

            .message.user {
                max-width: 250px;

            }





        }
    </style>
</head>

<body>

    <div class="top">
        <div>
            <button id="settings-btn" class="panel-btn"><i class="bi bi-sliders"></i></button>
        </div>
        <div class="ai"><img src="zara.png"></i></div>
        <div class="top-bar">
            <button id="theme" title="Toggle theme"><i class="bi bi-brightness-low"></i></button>
        </div>
    </div>

    <!-- Settings panel -->
    <div id="settings-panel" class="settings-panel" aria-hidden="true">
        <div class="fixed">
            <div class="nav">
                <div class="ai"><img src="z.png" alt=""></div>
                <button id="close-settings" class="panel-b"><i class="bi bi-x"></i></button>
            </div>
            <button id="new-chat-btn" class="panel-btn"><i class="bi bi-plus-circle"></i> New Chat</button>
            <label><input type="checkbox" id="dark-mode-toggle"> Dark Mode</label>
            <!-- Search input box for chat history -->

            <h3 style="margin-bottom: 10px;"><i style="padding-right: 10px; " class="bi bi-pencil-square"></i>Chat
                History</h3>
            <div class="se">
                <input type="text" id="chat-search" placeholder="Search chats...">
                <i class="bi bi-search"></i>
            </div>




        </div>




        <div class="his">
            <ul id="chat-history"></ul>
        </div>




    </div>



    <div class="chat-container" id="chat-container">
        <div id="welcome-heading" class="center-heading">Welcome to Zara AI</div>
    </div>

    <form id="chat-form">
        <div id="preview-container"></div>
        <div class="input-wrapper">
            <div id="user-input" class="editable-input" contenteditable="true" placeholder="Ask me Anything..."></div>
            <div class="up">
                <label for="file-upload" class="icon-btn file-icon" title="Attach files"><i
                        class="bi bi-arrow-up-square"></i></label>
                <input type="file" id="file-upload" hidden multiple accept="image/*">

                <button type="button" class="icon-btn mic-icon" title="Mic"><i class="bi bi-mic"></i></button>
                <div id="siriWave" class="siri-wrap" aria-hidden="true"></div>
                <button id="send-btn" type="submit" class="send-btn" title="Send">‚û§</button>

            </div>
        </div>

    </form>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        import { GoogleGenAI, Modality } from "https://esm.run/@google/genai";

        const API_KEY = "AIzaSyDuQKgj8UdV-pyS26mQnwwzY7ROwV1i_kk"; // ‚ö†Ô∏è Replace with your actual API key
        const genAI = new GoogleGenerativeAI(API_KEY);
        const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
        (function () {
            // Elements
            //  const chat = chatHistory.getElementsByTagName('li');
            const chatSearch = document.getElementById('chat-search');
            const micBtn = document.querySelector('.mic-icon');
            const siriWrap = document.getElementById('siriWave');
            const form = document.getElementById("chat-form");
            const input = document.getElementById("user-input");
            const chatContainer = document.getElementById("chat-container");
            const fileInput = document.getElementById("file-upload");
            const previewContainer = document.getElementById("preview-container");
            const settingsBtn = document.getElementById("settings-btn");
            const settingsPanel = document.getElementById("settings-panel");
            const closeBtn = document.getElementById("close-settings");
            const newChatBtn = document.getElementById("new-chat-btn");
            const chatHistoryList = document.getElementById("chat-history");
            const themeBtn = document.getElementById("theme");
            const darkToggle = document.getElementById("dark-mode-toggle");
            const welcomeHeading = document.getElementById("welcome-heading");


            // State
            let uploadedFiles = [];
            let chats = []; // {id, name, messages: [{type:'text'|'image', sender:'user'|'bot', text?, data?}]}
            let currentChat = null;
            let firstMessageSent = false;



            // Helpers: storage
            function loadChatsFromStorage() {
                try {
                    const raw = localStorage.getItem("chatsData");
                    chats = raw ? JSON.parse(raw) : [];
                } catch (e) {
                    console.error("Failed to parse chatsData:", e);
                    chats = [];
                }
            }
            function saveChatsToStorage() {
                try {
                    localStorage.setItem("chatsData", JSON.stringify(chats));
                } catch (e) {
                    console.error("Failed to save chatsData:", e);
                }
            }


            // Render chat history list
            function renderChatHistory() {
                chatHistoryList.innerHTML = "";
                chats.forEach(ch => {
                    const li = document.createElement("li");
                    li.style.display = "flex";
                    li.style.justifyContent = "space-between";
                    li.style.alignItems = "center";

                    const span = document.createElement("span");
                    span.textContent = ch.name || ("Chat " + ch.id);
                    span.style.flex = "1";
                    span.style.cursor = "pointer";
                    span.addEventListener("click", () => {
                        currentChat = ch.id;
                        loadChat(ch.id);
                        settingsPanel.classList.remove("open");
                    });

                    const delBtn = document.createElement("button");
                    delBtn.textContent = "‚úï";
                    delBtn.style.background = "transparent";
                    delBtn.style.border = "none";
                    delBtn.style.color = "red";
                    delBtn.style.cursor = "pointer";
                    delBtn.title = "Delete chat";
                    delBtn.addEventListener("click", (e) => {
                        e.stopPropagation(); // prevent chat from loading
                        if (confirm("Delete this chat?")) {
                            chats = chats.filter(c => c.id !== ch.id);
                            saveChatsToStorage();
                            renderChatHistory();
                            if (currentChat === ch.id) {
                                currentChat = null;
                                chatContainer.innerHTML = "";
                                welcomeHeading.style.display = "block";
                            }
                        }
                    });

                    li.appendChild(span);
                    li.appendChild(delBtn);
                    chatHistoryList.appendChild(li);
                });
            }
            // --- Chat history search ---
            if (chatSearch) {
                chatSearch.addEventListener('input', function () {
                    const filter = chatSearch.value.toLowerCase();
                    const items = chatHistoryList.getElementsByTagName('li');
                    for (let i = 0; i < items.length; i++) {
                        const span = items[i].querySelector('span');
                        const text = span ? span.textContent || span.innerText : '';
                        items[i].style.display = text.toLowerCase().includes(filter) ? '' : 'none';
                    }
                });
            }

            // --- Siri Wave setup ---

            // 24 bars banao different delay/amp ke saath
            (function buildSiriBars() {
                const bars = 24;
                for (let i = 0; i < bars; i++) {
                    const b = document.createElement('div');
                    b.className = 'siri-bar';
                    // center ke bars thode bade, edges chhote (Siri feel)
                    const center = Math.abs(i - (bars - 1) / 2);
                    const amp = 1.4 - (center / (bars / 2)) * 0.9; // 1.4 .. 0.5
                    b.style.setProperty('--amp', amp.toFixed(2));
                    b.style.animationDelay = `${(i % 6) * 0.08}s`;
                    siriWrap.appendChild(b);
                }
            })();

            // toggle state
            let isListening = false;
            let waveEl = null;
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = "hi-IN"; // Hindi
            recognition.interimResults = false;

            function speak(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "hi-IN";
                window.speechSynthesis.speak(utterance);
            }
            micBtn.addEventListener('click', () => {
                isListening = !isListening;

                if (isListening) {
                    // wave element create
                    waveEl = document.createElement('div');
                    waveEl.className = 'body-wave';
                    document.body.appendChild(waveEl);
                    siriWrap.classList.add('active');
                    micBtn.classList.add('mic-listening');
                    recognition.start(); // üé§ start listening
                } else {
                    // wave stop
                    stopRecognition();
                }
                function stopRecognition() {
                    siriWrap.classList.remove('active');
                    micBtn.classList.remove('mic-listening');
                    recognition.stop();
                    if (waveEl) {
                        waveEl.remove();
                        waveEl = null;
                    }
                }

                recognition.onresult = async (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    console.log("You said:", transcript);

                    // AI bolne se pehle recognition ko rok do
                    recognition.abort();

                    try {
                        const result = await model.generateContent(transcript);
                        const reply = result.response.text();

                        const utterance = new SpeechSynthesisUtterance(reply);
                        utterance.lang = "hi-IN";

                        utterance.onend = () => {
                            // Jab AI bolna khatam kare, tab dobara recognition start karo
                            if (isListening) recognition.start();
                        };

                        speechSynthesis.speak(utterance);

                    } catch (err) {
                        console.error("AI error:", err);
                        if (isListening) recognition.start();
                    }
                };

                recognition.onend = () => {
                    // Agar AI bol raha ho to start mat karna, sirf user stop ke liye
                    if (isListening && !speechSynthesis.speaking) {
                        recognition.start();
                    }
                };
            });

            function markdownToHTML(text) {
                let html = text
                    // Headings ko emoji ke sath
                    .replace(/^### (.*$)/gim, "ü§ñ <h3>$1</h3>")
                    .replace(/^## (.*$)/gim, "‚≠ê <h2>$1</h2>")
                    .replace(/^# (.*$)/gim, "üìå <h1>$1</h1>")
                    // Bold
                    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
                    // Italic
                    .replace(/\*(.*?)\*/g, "<i>$1</i>")
                    // Bullet list
                    .replace(/^\s*[-*]\s+(.*)/gim, "‚Ä¢ $1")
                    // Code blocks
                    .replace(/```([\s\S]*?)```/g, "<pre><code>$1</code></pre>")
                    // Inline code
                    .replace(/`([^`]+)`/g, "<code>$1</code>")
                    // Line breaks
                    .replace(/\n/g, "<br>");
                return html.trim();
            }
            // --- Fullscreen Image Helper ---
            function showImageFullscreen(src) {
                const overlay = document.createElement("div");
                overlay.style.position = "fixed";
                overlay.style.top = "0";
                overlay.style.left = "0";
                overlay.style.width = "100%";
                overlay.style.height = "100%";
                overlay.style.backgroundColor = "rgba(0,0,0,0.85)";
                overlay.style.display = "flex";
                overlay.style.alignItems = "center";
                overlay.style.justifyContent = "center";
                overlay.style.cursor = "zoom-out";
                overlay.style.zIndex = "9999";
                overlay.style.transition = "opacity 0.3s ease";
                overlay.style.opacity = "0";

                const img = document.createElement("img");
                img.src = src;
                img.style.maxWidth = "90%";
                img.style.maxHeight = "90%";
                img.style.borderRadius = "10px";
                img.style.boxShadow = "0 0 20px rgba(0,0,0,0.5)";
                img.style.transform = "scale(0.9)";
                img.style.transition = "transform 0.3s ease";
                overlay.appendChild(img);

                overlay.addEventListener("click", () => {
                    img.style.transform = "scale(0.9)";
                    overlay.style.opacity = "0";
                    setTimeout(() => overlay.remove(), 300);
                });

                document.body.appendChild(overlay);
                requestAnimationFrame(() => {
                    overlay.style.opacity = "1";
                    img.style.transform = "scale(1)";
                });
            }

            // --- Make all images in a container clickable ---
            function makeImagesFullscreen(container) {
                const imgs = container.querySelectorAll("img");
                imgs.forEach(img => {
                    img.style.cursor = "zoom-in";
                    if (!img.dataset.fullscreen) { // avoid duplicate listeners
                        img.dataset.fullscreen = "true";
                        img.addEventListener("click", () => showImageFullscreen(img.src));
                    }
                });
            }

            // Load a chat into UI
            function loadChat(chatId) {
                const chatObj = chats.find(c => c.id === chatId);
                if (!chatObj) return;
                chatContainer.innerHTML = "";
                chatObj.messages.forEach(m => {
                    if (m.type === "image") {
                        const img = document.createElement("img");
                        img.src = m.data;
                        img.style.maxWidth = "240px";
                        img.style.borderRadius = "10px";
                        img.style.margin = "6px 0";
                        if (m.sender === "user") img.style.marginLeft = "auto";
                        chatContainer.appendChild(img);
                    } else {
                        addMessageToUI(m.sender, m.text);
                    }
                });
                makeImagesFullscreen(chatContainer); // ‚úÖ Fullscreen listener add
                welcomeHeading.style.display = "none";
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Add message UI only
            function addMessageToUI(sender, text) {
                const div = document.createElement("div");
                div.classList.add("message", sender === "user" ? "user" : "bot");
                div.innerText = text;
                chatContainer.appendChild(div);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return div;
            }

            // Save message to storage for current chat
            function saveMessageToChat(msg) {
                if (!currentChat) {
                    // create a new chat automatically
                    const chatName = "Chat " + (chats.length + 1);
                    const newChat = { id: Date.now(), name: chatName, messages: [] };
                    chats.push(newChat);
                    currentChat = newChat.id;
                }
                const chatObj = chats.find(c => c.id === currentChat);
                if (!chatObj) return;
                chatObj.messages.push(msg);
                saveChatsToStorage();
                renderChatHistory();
            }

            // Render preview thumbnails
            function renderPreview() {
                previewContainer.innerHTML = "";
                uploadedFiles.forEach((file, idx) => {
                    if (!file.type.startsWith("image/")) return;
                    const reader = new FileReader();
                    reader.onload = e => {
                        const wrapper = document.createElement("div");
                        wrapper.style.position = "relative";
                        wrapper.style.display = "inline-block";

                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.style.width = "60px";
                        img.style.height = "60px";
                        img.style.objectFit = "cover";
                        img.style.borderRadius = "6px";

                        const close = document.createElement("button");
                        close.innerText = "‚úï";
                        close.title = "Remove";
                        Object.assign(close.style, { position: "absolute", top: "-6px", right: "-6px", background: "rgba(0,0,0,.6)", color: "#fff", border: "none", width: "18px", height: "18px", borderRadius: "50%", cursor: "pointer" });
                        close.addEventListener("click", () => {
                            uploadedFiles.splice(idx, 1);
                            renderPreview();
                        });

                        wrapper.appendChild(img);
                        wrapper.appendChild(close);
                        previewContainer.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });
            }

            // Auto-resize contenteditable (approx)
            function adjustInputHeight() {
                // We can't reliably use scrollHeight on contenteditable for all browsers. Keep minimal
                input.style.minHeight = "56px";
            }

            // Event handlers
            input.addEventListener("input", adjustInputHeight);

            fileInput.addEventListener("change", (e) => {
                const files = Array.from(e.target.files || []);
                uploadedFiles.push(...files);
                renderPreview();
            });




            settingsBtn.addEventListener("click", () => settingsPanel.classList.toggle("open"));
            closeBtn.addEventListener("click", () => settingsPanel.classList.remove("open"));

            themeBtn.addEventListener("click", () => {
                document.body.classList.toggle("dark-theme");
            });
            darkToggle.addEventListener("change", (e) => {
                document.body.classList.toggle("dark-theme", e.target.checked);
            });

            newChatBtn.addEventListener("click", () => {
                const name = prompt("Enter chat name:") || ("Chat " + (chats.length + 1));
                const newChat = { id: Date.now(), name, messages: [] };
                chats.push(newChat);
                saveChatsToStorage();
                renderChatHistory();
                currentChat = newChat.id;
                chatContainer.innerHTML = "";
                welcomeHeading.style.display = "none";
            });
            async function typeWriterEffect(element, text, speed = 200) {
                element.innerText = "";
                const words = text.split(" "); // split by space
                for (let i = 0; i < words.length; i++) {
                    element.innerText += (i === 0 ? "" : " ") + words[i];
                    await new Promise(resolve => setTimeout(resolve, speed));
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            // ---- Clean Markdown properly ----
            function cleanMarkdown(text) {
                return text
                    // Code blocks hatao
                    .replace(/```[\s\S]*?```/g, "")
                    // Inline code hatao
                    .replace(/`([^`]+)`/g, "$1")
                    // Headings hatao (#, ##, ###)
                    .replace(/^#+\s?/gm, "")
                    // Bold / Italic
                    .replace(/\*\*(.*?)\*\*/g, "$1")
                    .replace(/\*(.*?)\*/g, "$1")
                    .replace(/_(.*?)_/g, "$1")
                    // Links [text](url) => text
                    .replace(/\[(.*?)\]\((.*?)\)/g, "$1")
                    // Blockquotes
                    .replace(/^>\s?/gm, "")
                    // Lists
                    .replace(/^\s*[-*]\s+/gm, "‚Ä¢ ")
                    .replace(/^\s*\d+\.\s+/gm, "‚Ä¢ ")
                    // Tables ke pipes hatao
                    .replace(/\|/g, " ")
                    // Extra newlines clean karo
                    .replace(/\n{2,}/g, "\n")
                    .trim();
            }

            // ---- Placeholder add karne ke liye ----
            function addPlaceholderMessage(sender) {
                const msgBox = document.createElement("div");
                msgBox.className = `msg ${sender} thinking`;

                msgBox.innerHTML = `
      <div class="typing-dots"> 
        <span></span><span></span><span></span>
      </div>
    `;

                chatContainer.appendChild(msgBox);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return msgBox;
            }

            // ---- Updated generateAIResponse ----
            async function generateAIResponse(userText) {
                const chatObj = chats.find(c => c.id === currentChat);
                let historyText = "";

                if (chatObj && chatObj.messages.length) {
                    chatObj.messages.forEach(m => {
                        if (m.type === "text") {
                            historyText += `${m.sender === "user" ? "User" : "AI"}: ${m.text}\n`;
                        }
                    });
                }

                const isImageRequest = /image|‡§ö‡§ø‡§§‡•ç‡§∞|photo|‡§ö‡§ø‡§§‡•ç‡§∞ ‡§¨‡§®‡§æ‡§ì/i.test(userText);

                // Placeholder show karo
                const placeholder = addPlaceholderMessage("bot");

                try {
                    if (isImageRequest) {
                        // üîπ Image ke liye sirf current prompt bhejna hai (history nahi)
                        const ai = new GoogleGenAI({ apiKey: API_KEY });
                        let response = await ai.models.generateContent({
                            model: "gemini-2.0-flash-preview-image-generation",
                            contents: [{ type: "text", text: userText }],
                            config: { responseModalities: [Modality.TEXT, Modality.IMAGE] }
                        });

                        let replyText = null, replyImage = null;
                        let parts = response.candidates?.[0]?.content?.parts || [];

                        for (const part of parts) {
                            if (part.text) replyText = cleanMarkdown(part.text);
                            if (part.inlineData?.data) replyImage = `data:image/png;base64,${part.inlineData.data}`;
                            else if (part.imageUri) replyImage = part.imageUri;
                        }

                        // üîÅ Retry agar image na mili
                        if (!replyImage) {
                            console.warn("‚ö†Ô∏è No image generated, retrying...");
                            response = await ai.models.generateContent({
                                model: "gemini-2.0-flash-preview-image-generation",
                                contents: [{ type: "text", text: userText }],
                                config: { responseModalities: [Modality.IMAGE] } // retry me sirf image maango
                            });

                            parts = response.candidates?.[0]?.content?.parts || [];
                            for (const part of parts) {
                                if (part.inlineData?.data) replyImage = `data:image/png;base64,${part.inlineData.data}`;
                                else if (part.imageUri) replyImage = part.imageUri;
                            }
                        }

                        return { text: replyText, image: replyImage };

                    } else {
                        // üîπ Text ke liye history + user input
                        const fullPrompt = historyText + `User: ${userText}\nAI:`;
                        const textResult = await textModel.generateContent(fullPrompt);
                        let replyText = textResult.response.text();
                        replyText = cleanMarkdown(replyText);
                        return { text: replyText, image: null };
                    }
                } catch (err) {
                    console.error("AI Error:", err);
                    return { text: "‚ùå Sorry, AI response failed.", image: null };
                } finally {
                    // Placeholder hamesha remove hoga
                    if (placeholder) placeholder.remove();
                }
            }



            // --- AI Response ---
            // Submit form (send)
            form.addEventListener("submit", async (ev) => {
                ev.preventDefault();
                const userText = input.innerText.trim();

                if (!userText && uploadedFiles.length === 0) return;

                // hide welcome

                const heading = document.getElementById("welcome-heading");
                if (heading) heading.style.display = "none";
                // ---- Pehla message bhejne par theme change karo ----
                if (!firstMessageSent) {
                    document.body.classList.add("active-chat"); // background change
                    firstMessageSent = true;

                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 10);
                }
                const messageBlock = document.createElement("div");
                messageBlock.style.display = "flex";
                messageBlock.style.flexDirection = "column";
                messageBlock.style.alignItems = "flex-end";
                messageBlock.style.marginBottom = "10px";

                // message block for images then text
                // first images

                // --- Show uploaded images ---
                if (uploadedFiles.length) {
                    for (let file of uploadedFiles) {
                        if (file.type.startsWith("image/")) {
                            const reader = new FileReader();
                            await new Promise(resolve => {
                                reader.onload = e => {
                                    const dataUrl = e.target.result;
                                    const img = document.createElement("img");

                                    img.src = dataUrl;
                                    img.style.maxWidth = "240px";
                                    img.style.borderRadius = "10px";
                                    img.style.margin = "6px 0";
                                    img.style.display = "block";
                                    img.style.marginLeft = "auto";
                                    img.style.cursor = "zoom-in";
                                    chatContainer.appendChild(img);
                                    // üîÅ Fullscreen click listener 
                                    img.addEventListener("click", () => showImageFullscreen(img.src));

                                    // --- Download button ---
                                    const downloadLink = document.createElement("a");
                                    downloadLink.href = dataUrl;
                                    downloadLink.download = file.name;
                                    downloadLink.innerText = "‚¨áÔ∏è Download";

                                    downloadLink.style.display = "inline-block";
                                    downloadLink.style.margin = "2px 0 8px 4px";
                                    downloadLink.style.padding = "0";
                                    downloadLink.style.fontSize = "14px";
                                    downloadLink.style.color = "#4CAF50";
                                    downloadLink.style.background = "none";
                                    downloadLink.style.border = "none";
                                    downloadLink.style.borderRadius = "0";
                                    downloadLink.style.textDecoration = "none";
                                    downloadLink.style.cursor = "pointer";
                                    downloadLink.style.marginLeft = "auto";

                                    chatContainer.appendChild(downloadLink);


                                    saveMessageToChat({ type: "image", sender: "user", data: dataUrl });
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                    uploadedFiles = [];
                                    previewContainer.innerHTML = "";
                                    fileInput.value = "";
                                    resolve();
                                };
                                reader.readAsDataURL(file);
                            });
                        }
                    }
                }


                // then text
                if (userText) {
                    addMessageToUI("user", userText);
                    saveMessageToChat({ type: "text", sender: "user", text: userText });
                    input.innerText = "";
                    adjustInputHeight();
                }

                // ‚úÖ Word-by-word typing effect (with proper spaces)
                // ‚úÖ Markdown cleaner function

                // show bot thinking
                const botDiv = document.createElement("div");
                botDiv.classList.add("message", "bot");
                chatContainer.appendChild(botDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                // Generate AI response
                const aiReply = await generateAIResponse(userText);

                // Show text reply
                if (aiReply.text) {
                    await typeWriterEffect(botDiv, aiReply.text, 40);
                    saveMessageToChat({ type: "text", sender: "bot", text: aiReply.text });
                    // reset inputs

                }

                if (aiReply.image) {
                    // Create wrapper div
                    const wrapper = document.createElement("div");
                    wrapper.style.display = "inline-block";
                    wrapper.style.marginBottom = "10px";
                    const botImg = document.createElement("img");
                    botImg.src = aiReply.image;
                    botImg.style.maxWidth = "240px";
                    botImg.style.borderRadius = "10px";
                    botImg.style.margin = "6px 0";
                    botImg.style.cursor = "zoom-in"
                    botImg.addEventListener("click", () => showImageFullscreen(botImg.src));
                    chatContainer.appendChild(botImg);

                    const downloadLink = document.createElement("a");
                    downloadLink.href = aiReply.image;
                    downloadLink.download = "AI_Image.png";
                    downloadLink.innerText = "‚¨áÔ∏è Download";
                    downloadLink.style.display = "inline-block";
                    downloadLink.style.margin = "2px 0 8px 4px";
                    downloadLink.style.padding = "0";
                    downloadLink.style.fontSize = "14px";
                    downloadLink.style.color = "#4CAF50";
                    downloadLink.style.background = "none";
                    downloadLink.style.border = "none";
                    downloadLink.style.borderRadius = "0";
                    downloadLink.style.textDecoration = "none";
                    downloadLink.style.cursor = "pointer";
                    downloadLink.style.float = "right";

                    chatContainer.appendChild(downloadLink);

                    saveMessageToChat({ type: "image", sender: "bot", data: aiReply.image }); // ‚úÖ ‡§∏‡§π‡•Ä

                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                // Call backend (if available) ‚Äî fallback to canned reply

            });

            // Initialization
            loadChatsFromStorage();
            renderChatHistory();
            // If there is at least one chat, auto-open the last one
            if (!chats.length) {
                welcomeHeading.style.display = "block";
            } else {
                welcomeHeading.style.display = "block"; // force show even if chats exist
            }
            // Expose for debugging (optional)
            window._zara = { chats, saveChatsToStorage, loadChatsFromStorage };
        })();
    </script>
</body>

</html>
